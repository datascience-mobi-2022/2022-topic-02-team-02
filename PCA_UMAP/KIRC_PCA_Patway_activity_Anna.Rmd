---
title: "KIRC_Pathway_activity_PCA_Anna"
author: "Anna von Bachmann"
date: '2022-06-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Load data}
#Load data
tcga_tumor_norm = readRDS("~/GitHub/2022-topic-02-team-02/data/tcga_tumor_normal_datascience_proj_2022.RDS")
KIRC_annot = data.frame(tcga_tumor_norm[["KIRC"]][["clinical"]]) #annotation

KIRC_pa =  readRDS("~/GitHub/2022-topic-02-team-02/data/KIRC_GSEA_activity.rds")

#depending on which pathways you want to analyze, assign the variable accordingly
#KIRC_pa = KIRC_GSEA_activity_PID
#KIRC_pa = KIRC_GSEA_activity_hallmark
#KIRC_pa = KIRC_GSEA_activity_KEGG
```


```{r PCA}
#run pca 
KIRC_pa_pca = prcomp(t(KIRC_pa))#center = F, scale. = F???
length(KIRC_pa_pca$sdev) #72 patients resulting in 72 PCs as rank of matrix = number of PCs

#dataframe with PCs (resulting from pathways) and patients
KIRC_pa_pca_x = data.frame(KIRC_pa_pca[["x"]])

#get the eigenvalues for each PC (eigenvalues measure the amount of variation retained by each PC)
library("factoextra")
KIRC_pa_pca_eigval = get_eigenvalue(KIRC_pa_pca)
rownames(KIRC_pa_pca_eigval) = colnames (KIRC_pa_pca_x)
barplot(KIRC_pa_pca_eigval$variance.percent,ylab='Proportion of variance in percent', xlab = "Principal Components")
```


```{r PCA plot}
#plot the data (patients in coordinate system with PC1, PC2/PC3 as axes)

ggplot(KIRC_pa_pca_x, aes(PC1, PC2))+  #plot PC1 and PC2
  geom_point( size =2)

ggplot(KIRC_pa_pca_x, aes(PC1, PC3))+   #plot in PC1  and PC3
  geom_point( size =2)
  

#plot the data (patients) in the first principal components regarding gender
KIRC_gender = ifelse(KIRC_annot$gender == "FEMALE", "red", "blue")#gender-vector
sum(KIRC_annot$gender=="FEMALE")

ggplot(KIRC_pa_pca_x, aes(PC1, PC2))+  #plot PC1 and pC2
  geom_point( size =2, color = KIRC_gender)+
   ggtitle("PCA with regard to gender ")

ggplot(KIRC_pa_pca_x, aes(PC1, PC3))+
  geom_point( size =2, color = KIRC_gender)+
   ggtitle("PCA with regard to gender ")
```
```{r UMAP}
#UMAP for better clusterin/visualization, running on PCA result
library(uwot)
KIRC_pa_UMAP= uwot::umap(KIRC_pa_pca_x)
KIRC_pa_UMAP = data.frame(KIRC_pa_UMAP)
#plot
ggplot (data = KIRC_pa_UMAP, 
                    aes(x = X1, y = X2))+
  geom_point(size = 2)

#plot with colors for gender

KIRC_tumorstatus = KIRC_annot$tumor_status
KIRC_gender_Umap = KIRC_annot$gender  #vector for coloring 
KIRC_pa_UMAP = data.frame(KIRC_pa_UMAP)

ggplot (data =KIRC_pa_UMAP, 
                    aes(x = X1, y = X2 , color = KIRC_tumorstatus))+
  geom_point(size = 1)

ggplot (data =KIRC_pa_UMAP, 
                    aes(x = X1, y = X2 , color = KIRC_gender_Umap))+
  geom_point(size = 1)
```


```{r Kmeans }
library(cluster)
#perform kmeans with 2:5 centers on UMAP results
KIRC_UMAP_kmeans = sapply(2:5, function(k){
  kmeans(x = KIRC_pa_UMAP , centers = k, nstart = 50 )})



#find the optimal number of clusters

#extract tot.withinss --> for silhouette plot (elbow method)
KIRC_UMAP_kmeans_tw = sapply(1:5, function(k){
  kmeans(x = KIRC_pa_UMAP , centers = k, nstart = 50 )$tot.withinss})

#elbow plot
plot(KIRC_UMAP_kmeans_tw, type = "b", pch= 20, xlab = "centers", ylab = "Total within-clusters sum of squares")

#extract cluster values for silhouette plot
KIRC_UMAP_kmeans_c = sapply(2:7, function(k){
  kmeans(x = KIRC_pa_UMAP , centers = k, nstart = 50 )$cluster})

#silhouette plot
sapply(1:6, function(x){
  plot(silhouette(KIRC_UMAP_kmeans_c[,x], dist(KIRC_pa_UMAP)), main ="Silhouette plot")})


#find the optimal number clusters, silhouette plot (average silhouette width)
fviz_nbclust(KIRC_pa_UMAP, kmeans, method='silhouette')
```
```{r Kmeans Plot}
# visualize the clusters in plot
library(ggpubr)
library(factoextra)
#for 2 centers
km.2 = kmeans(KIRC_pa_UMAP, centers = 2, nstart = 200)
fviz_cluster(km.2, KIRC_pa_UMAP,
             palette = c("orange", "blue"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )

# for 3 centers
km.3 = kmeans(KIRC_pa_UMAP, centers = 3, nstart = 50)
fviz_cluster(km.3, KIRC_pa_UMAP,
             palette = c("orange", "blue", "forestgreen"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )

# for 4 centers
km.4 = kmeans(KIRC_pa_UMAP, centers = 4, nstart = 50)
fviz_cluster(km.4, KIRC_pa_UMAP,
             palette = c("orange", "blue", "forestgreen", "black"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )

```


```{r}
#for PID pathways: optimal number ckusters = 2
PID_km2 =kmeans(KIRC_pa_UMAP, 2 ,nstart = 50)
PID_km = PID_km2$cluster
PID_c1_names = names(PID_km[which(PID_km == 1)]) #patient names of cluster1
PID_c2_names = names(PID_km[which(PID_km == 2)]) # patient names of cluster2
fviz_cluster(PID_km2, KIRC_pa_UMAP,
             palette = c("orange", "blue"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )
#see above for colored UMAP--> cluster 2: more tumor free patients

PID_c1 = KIRC_pa[,colnames(KIRC_pa) %in% PID_c1_names] # df with patients of cluster1
PID_c2 = KIRC_pa[,!colnames(KIRC_pa) %in% PID_c1_names] #df with patients cluster 2
PID_c1_mean = data.frame(apply(PID_c1, 1,mean)) #pw activity mean for patients of cluster 1
PID_c2_mean = data.frame (apply (PID_c2, 1, mean)) #fpr cluster 2
PID_c1_c2 = cbind(PID_c2_mean, PID_c1_mean) #combine mean cluster 1 and cluster2 
PID_c1_c2_dif = PID_c1_mean - PID_c2_mean #compare the mean activity scores of pathways
#high scores means upregulated in cluster 1 

#rank the compared pw-matrix to see the most differently expressed pw
PID_c1_c2_dif_rank = data.frame(PID_c1_c2_dif$apply.PID_c1..1..mean.[order(PID_c1_c2_dif[,1],decreasing = TRUE)])
PID_rownames = c(rownames(PID_c1_c2_dif))
PID_rownames_rank = data.frame(PID_rownames[order(PID_c1_c2_dif[,1],decreasing = TRUE)])

PID_c1_c2_dif_rank = cbind(PID_rownames_rank, PID_c1_c2_dif_rank)
colnames(PID_c1_c2_dif_rank) = c("Pathway", "diff")

PID_c1_c2_dif_rank%>%
  filter(PID_c1_c2_dif_rank$dif!=0)%>%
ggplot( aes(x=reorder(Pathway,diff), y=diff)) +
  geom_bar(stat="identity")+
  coord_flip()
  
       


PID_c1_c2_dif_rank%>%
  filter(abs(PID_c1_c2_dif_rank$dif)>0.20)%>%
ggplot( aes(x=reorder(Pathway,diff), y=diff)) +
  geom_bar(stat="identity")+
  coord_flip()
```



