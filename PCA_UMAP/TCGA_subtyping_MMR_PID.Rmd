---
title: "TCGA_subtyping_MMR/PID"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r data}
#load pathway activity matricesd for MMR and PID for all 33 tumortypes
TCGA_pw_MMR = readRDS("../data/NES_OVERALL_MMR.RDS")
TCGA_pw_PID =  readRDS("~/Desktop/GitHub/2022-topic-02-team-02/data/NES_OVERALL_PID_cl.RDS")
```

```{r packages}
library(ggplot2)
library(tidyverse)
library(Seurat)
library(gridExtra)
library(cluster)
library(ggpubr)
library(factoextra)
set.seed(69)
```

```{r PCA / umap for PID}

cancer_abc = names(TCGA_pw_MMR)
PCA_PID = lapply (1:length(TCGA_pw_PID), function (i) {
  RunPCA(as.matrix(TCGA_pw_PID[[i]]),npcs = (nrow(TCGA_pw_MMR[[i]])-1)
         )
         }) 

UMAP_PID = lapply (1:length(TCGA_pw_PID), function (j) {
  uwot::umap(PCA_PID[[j]]@cell.embeddings)
})

UMAP_output_PID = list ()
for (i in 1: length(TCGA_pw_PID)) {
  UMAP_df_PID = data.frame(UMAP_PID[[i]])
  UMAP_output_PID[[i]] = ggplot (data = UMAP_df_PID,
  aes (x = X1, y =X2, color = "blue")) + 
    geom_point(size = 0.5 , color = "blue")+ 
    ggtitle (cancer_abc [[i]])
}
names(UMAP_output_PID) = cancer_abc
View(UMAP_output_PID)
do.call("ggarrange", c(UMAP_output_PID))

ggarrange(plotlist=UMAP_output_PID)
```

```{r PCA / umap for MMR}
PCA_MMR = lapply (1:length(TCGA_pw_MMR), function (i) {
  RunPCA(as.matrix(TCGA_pw_MMR[[i]]), npcs = (nrow(TCGA_pw_MMR[[i]])))
         }) 

UMAP_MMR = lapply (1:length(TCGA_pw_MMR), function (j) {
  uwot::umap(PCA_MMR[[j]]@cell.embeddings)
})

UMAP_output_MMR = list ()
for (i in 1: length(TCGA_pw_MMR)) {
  UMAP_df_MMR = data.frame(UMAP_MMR[[i]])
  UMAP_output_MMR[[i]] = ggplot (data = UMAP_df_MMR,
  aes (x = X1, y =X2, color = "blue")) + 
    geom_point(size = 0.5 , color = "blue")+ 
    ggtitle (cancer_abc [[i]])
}
names(UMAP_output_MMR) = cancer_abc
ggarrange(plotlist = UMAP_output_MMR)

```

```{r kmeans for PID}
set.seed(69)
kmeans_PID = vector(mode = "list",33)
for (i in (1:length(UMAP_PID))){
  for (k in (1:5)) {
    x = UMAP_PID[[i]]
    kmeans_PID[[i]][[k]] = kmeans(x, centers = k, nstart = 200)
  }
}
names(kmeans_PID) = cancer_abc


cluster_PID = vector(mode = "list",33)
for(i in (1:length(cluster_PID))){
  for (k in (1:5)){
    y = kmeans_PID[[i]][[k]]
    z = data.frame(UMAP_PID[[i]])
    cluster_PID[[i]][[k]] = fviz_cluster(y, data = z,
             palette = c("orange", "blue","forestgreen","pink","yellow"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )
  }
}

names(cluster_PID) = cancer_abc
ggarrange(plotlist = cluster_PID$ACC)


n = data.frame()
for (i in (1:length(UMAP_PID))){
 for (k in (1:5)) {
     n[k,i] = data.frame(kmeans_PID[[i]][[k]]$tot.withinss)
 }
}
```


```{r elbow plot for all}
tot_PID = list()
for (i in (1:length(UMAP_PID))){
    p  = data.frame(n[,i])
    colnames(p) = "b"
    t = cbind(p,w)
    tot_PID[[i]] = ggplot(data = t, aes(y = b, x = w ))+
      geom_point(size =2, color = "lightblue")+
      geom_line(group = 1, color = "lightblue")+
      labs (y = "tot withins",
        x = "cluster frequenz")+
      ggtitle(cancer_abc[i])
  }

names(tot_PID) = cancer_abc
tot1234 = list(tot_PID[[1]],tot_PID[[7]],tot_PID[[9]],tot_PID[[10]])
ggarrange(plotlist = tot_PID)
```



```{r create df for 2 clusters per tumortype}
#extract cluster information 
cluster12_PID = list(list())
for (i in (1:length(UMAP_PID))){
     cluster12_PID[i] = list(kmeans_PID[[i]][[2]][["cluster"]])
 }
names(cluster12_PID) = cancer_abc

cluster1_PID = list()
for (i in (1:length(UMAP_PID))){
     cluster1_PID[i] = names(cluster12_PID[i][which(cluster12_PID ==1)])
 }
 names(cluster1_PID) = cancer_abc

PID_c1_names = names(PID_km[which(PID_km == 1)]) #patient names of cluster1
PID_c2_names = names(PID_km[which(PID_km == 2)]) # patient names of cluster2




```

